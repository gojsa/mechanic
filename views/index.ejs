<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Form</title>
    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="/css/tables.css">
</head>
<body>
    <h1 class="header">Dobro dosli</h1>
    <form action="" method="POST" class="user-form">
        <div class="form-group">
            <label for="search" class="form-label">Pretrazi Korisnike:</label>
            <input type="text" id="search" name="search" class="form-input" placeholder="ime, prezime, jmbg">
        </div>
        <button type="button" class="form-button">Pretrazi</button>
    </form>

    <table class="user-table">
        <thead>
            <tr>
                <th>User ID</th>
                <th>First Name</th>
                <th>Last Name</th>
                <th>JMBG</th>
                <th>Birth Date</th>
                <th>Email</th>
                <th>Created At</th>
                <th>Updated At</th>
            </tr>
        </thead>
        <tbody id="user-table-body">
            <!-- Rows will be inserted here dynamically -->
        </tbody>
    </table>

     <!-- Pagination controls -->
     <div class="pagination">
        <button onclick="prevPage()">Previous</button>
        <span id="page-info"></span>
        <button onclick="nextPage()">Next</button>
    </div>

    <script>
        let currentPage = 1;
        const limit = 10;

        async function fetchUsers(page, search = '') {
            const response = await fetch(`/api/user/${limit}/${page}?search=${search}`);
            const data = await response.json();
            return data;
        }

        async function searchUsers() {
            const search = document.getElementById('search').value;
            currentPage = 1;
            const data = await fetchUsers(currentPage, search);
            renderTable(data.user);
            updatePageInfo(data.count);
        }

        function renderTable(users) {
            const tbody = document.getElementById('user-table-body');
            tbody.innerHTML = '';
            users.forEach(user => {
                const row = `<tr>
                    <td>${user.user_id}</td>
                    <td>${user.first_name}</td>
                    <td>${user.last_name}</td>
                    <td>${user.jmbg}</td>
                    <td>${new Date(user.birth_date).toLocaleDateString()}</td>
                    <td>${user.email}</td>
                    <td>${new Date(user.created_at).toLocaleString()}</td>
                    <td>${new Date(user.updated_at).toLocaleString()}</td>
                </tr>`;
                tbody.innerHTML += row;
            });
        }

        function updatePageInfo(count) {
            const pageInfo = document.getElementById('page-info');
            pageInfo.textContent = `Page ${currentPage} of ${Math.ceil(count / limit)}`;
        }

        async function prevPage() {
            if (currentPage > 1) {
                currentPage--;
                const search = document.getElementById('search').value;
                const data = await fetchUsers(currentPage, search);
                renderTable(data.user);
                updatePageInfo(data.count);
            }
        }

        async function nextPage() {
            const search = document.getElementById('search').value;
            const data = await fetchUsers(currentPage + 1, search);
            if (data.user.length > 0) {
                currentPage++;
                renderTable(data.user);
                updatePageInfo(data.count);
            }
        }

        // Initial load
        searchUsers();
    </script>
</body>
</html>